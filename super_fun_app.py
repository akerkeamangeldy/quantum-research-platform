import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
import pennylane as qml
from pennylane import numpy as pnp

st.set_page_config(page_title="Newton + Quantum Playground", page_icon="üçé", layout="centered")

st.title("üçé‚öõÔ∏è –ù—å—é—Ç–æ–Ω + –ö–≤–∞–Ω—Ç–æ–≤–∞—è –º–∞–≥–∏—è ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –º–∏–Ω–∏-–∏–≥—Ä–∞")
st.write("–ï—Å–ª–∏ —Ç—ã –≤–∏–¥–∏—à—å —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç ‚Äî –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ")

mode = st.radio(
    "–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º:",
    ["üçé –ù—å—é—Ç–æ–Ω: —è–±–ª–æ–∫–æ-—Ä–∞–∫–µ—Ç–∞", "‚öõÔ∏è –ö–≤–∞–Ω—Ç–æ–≤–∞—è –º–æ–Ω–µ—Ç–∫–∞ (–∫—É–±–∏—Ç)"],
    horizontal=True
)

st.markdown("---")

# ---------------------------
# üçé NEWTON MODE
# ---------------------------
if mode == "üçé –ù—å—é—Ç–æ–Ω: —è–±–ª–æ–∫–æ-—Ä–∞–∫–µ—Ç–∞":
    st.header("üçé –ù—å—é—Ç–æ–Ω: —è–±–ª–æ–∫–æ –ª–µ—Ç–∏—Ç –¥—É–≥–æ–π!")
    st.write("–¢—ã ‚Äî –∫–∞–∫ –ù—å—é—Ç–æ–Ω: —Ç—ã —É–ø—Ä–∞–≤–ª—è–µ—à—å –±—Ä–æ—Å–∫–æ–º –∏ —Å–º–æ—Ç—Ä–∏—à—å, —á—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è.")

    col1, col2 = st.columns(2)
    with col1:
        v0 = st.slider("–°–∫–æ—Ä–æ—Å—Ç—å –±—Ä–æ—Å–∫–∞ v0 (–º/—Å)", 1.0, 80.0, 25.0, 1.0)
        angle = st.slider("–£–≥–æ–ª (–≥—Ä–∞–¥—É—Å—ã)", 1, 89, 45, 1)
    with col2:
        world = st.selectbox("–ì–¥–µ –±—Ä–æ—Å–∞–µ–º?", ["–ó–µ–º–ª—è", "–õ—É–Ω–∞", "–ú–∞—Ä—Å", "–°–≤–æ–π g"])
        if world == "–ó–µ–º–ª—è":
            g = 9.81
        elif world == "–õ—É–Ω–∞":
            g = 1.62
        elif world == "–ú–∞—Ä—Å":
            g = 3.71
        else:
            g = st.slider("g (–º/—Å¬≤)", 0.1, 30.0, 9.81, 0.1)

    theta = np.deg2rad(angle)
    vx = v0 * np.cos(theta)
    vy = v0 * np.sin(theta)

    # –í—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞ (–∫–æ–≥–¥–∞ –≤–µ—Ä–Ω—ë—Ç—Å—è –Ω–∞ –∑–µ–º–ª—é)
    T = 2 * vy / g
    t = np.linspace(0, T, 400)
    x = vx * t
    y = vy * t - 0.5 * g * t**2

    H = (vy**2) / (2*g)   # –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞
    R = vx * T            # –¥–∞–ª—å–Ω–æ—Å—Ç—å

    c1, c2, c3 = st.columns(3)
    c1.metric("‚è±Ô∏è –í—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞", f"{T:.2f} s")
    c2.metric("üèîÔ∏è –ú–∞–∫—Å. –≤—ã—Å–æ—Ç–∞", f"{H:.2f} m")
    c3.metric("üìè –î–∞–ª—å–Ω–æ—Å—Ç—å", f"{R:.2f} m")

    fig, ax = plt.subplots()
    ax.plot(x, y)
    ax.set_xlabel("x (–º–µ—Ç—Ä—ã)")
    ax.set_ylabel("y (–º–µ—Ç—Ä—ã)")
    ax.set_title("–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è —è–±–ª–æ–∫–∞ (–¥—É–≥–∞ –ù—å—é—Ç–æ–Ω–∞)")
    ax.grid(True)
    st.pyplot(fig, clear_figure=True)

    st.subheader("üë∂ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞–∫ 5-–ª–µ—Ç–Ω–µ–º—É")
    st.write(
        "–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –±—Ä–æ—Å–∞–µ—à—å –º—è—á–∏–∫ üçé\n\n"
        "‚Äî –¢—ã —Ç–æ–ª–∫–∞–µ—à—å –µ–≥–æ **–≤–ø–µ—Ä—ë–¥** ‚Üí –æ–Ω –ª–µ—Ç–∏—Ç –≤–ø–µ—Ä—ë–¥.\n"
        "‚Äî –ó–µ–º–ª—è –≤—Å—ë –≤—Ä–µ–º—è —Ç—è–Ω–µ—Ç –µ–≥–æ **–≤–Ω–∏–∑** ‚Üí –ø–æ—ç—Ç–æ–º—É –æ–Ω –ª–µ—Ç–∏—Ç **–¥—É–≥–æ–π**, –∫–∞–∫ –≥–æ—Ä–∫–∞.\n\n"
        "–ù—å—é—Ç–æ–Ω —Å–∫–∞–∑–∞–ª –ø—Ä–æ—Å—Ç—É—é —Å—É–ø–µ—Ä-—Ñ—Ä–∞–∑—É:\n"
        "**–°–∏–ª–∞ —Ç–æ–ª–∫–∞–µ—Ç ‚Äî —Ç–µ–ª–æ —É—Å–∫–æ—Ä—è–µ—Ç—Å—è.**\n"
        "–ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è ‚Äî —ç—Ç–æ —Å–∏–ª–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—Å–µ–≥–¥–∞ —Ç—è–Ω–µ—Ç –≤–Ω–∏–∑ ü§≤"
    )

    st.markdown("---")
    st.caption("–•–æ—á–µ—à—å –µ—â—ë –∫—Ä—É—á–µ? –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å ‚Äî –æ—Ä–±–∏—Ç–∞: –∫–∞–∫ –õ—É–Ω–∞ ¬´–ø–∞–¥–∞–µ—Ç –∏ –ø—Ä–æ–º–∞—Ö–∏–≤–∞–µ—Ç—Å—è¬ª –º–∏–º–æ –ó–µ–º–ª–∏.")

# ---------------------------
# ‚öõÔ∏è QUANTUM MODE
# ---------------------------
else:
    st.header("‚öõÔ∏è –ö–≤–∞–Ω—Ç–æ–≤–∞—è –º–æ–Ω–µ—Ç–∫–∞ (–∫—É–±–∏—Ç)")
    st.write("–¢—ã –∫—Ä—É—Ç–∏—à—å —Ä—É—á–∫—É Œ∏ ‚Äî –∏ –º–µ–Ω—è—é—Ç—Å—è —à–∞–Ω—Å—ã —É–≤–∏–¥–µ—Ç—å 0 –∏–ª–∏ 1. –≠—Ç–æ –∫–≤–∞–Ω—Ç–æ–≤–∞—è –º–∞–≥–∏—è üôÇ")

    col1, col2 = st.columns(2)
    with col1:
        theta = st.slider("–ü–æ–≤–µ—Ä–Ω–∏ –∫–≤–∞–Ω—Ç–æ–≤—É—é —Ä—É—á–∫—É Œ∏ (—Ä–∞–¥–∏–∞–Ω—ã)", 0.0, float(2*np.pi), float(np.pi/3), 0.01)
    with col2:
        shots = st.slider("–°–∫–æ–ª—å–∫–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π (shots)", 50, 5000, 1000, 50)

    # –ò–¥–µ–∞–ª—å–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ (–±–µ–∑ shots)
    dev_probs = qml.device("default.qubit", wires=1)

    @qml.qnode(dev_probs)
    def probs_circuit(t):
        qml.RY(t, wires=0)
        return qml.probs(wires=0)

    probs = probs_circuit(theta)
    p0, p1 = float(probs[0]), float(probs[1])

    # "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç" (—Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π)
    dev_shots = qml.device("default.qubit", wires=1, shots=shots)

    @qml.qnode(dev_shots)
    def sample_circuit(t):
        qml.RY(t, wires=0)
        return qml.sample(wires=0)

    samples = sample_circuit(theta)
    count1 = int(pnp.sum(samples))
    count0 = int(len(samples) - count1)

    c1, c2, c3 = st.columns(3)
    c1.metric("–ò–¥–µ–∞–ª—å–Ω–æ P(0)", f"{p0:.3f}")
    c2.metric("–ò–¥–µ–∞–ª—å–Ω–æ P(1)", f"{p1:.3f}")
    c3.metric("–ò–∑–º–µ—Ä–∏–ª–∏ (0 / 1)", f"{count0} / {count1}")

    # –ì—Ä–∞—Ñ–∏–∫–∏
    st.subheader("üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (Matplotlib)")

    fig1, ax1 = plt.subplots()
    ax1.bar(["0", "1"], [p0, p1])
    ax1.set_ylim(0, 1)
    ax1.set_xlabel("–†–µ–∑—É–ª—å—Ç–∞—Ç")
    ax1.set_ylabel("–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å")
    ax1.set_title("–ò–¥–µ–∞–ª—å–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏")
    st.pyplot(fig1, clear_figure=True)

    fig2, ax2 = plt.subplots()
    ax2.bar(["0", "1"], [count0/shots, count1/shots])
    ax2.set_ylim(0, 1)
    ax2.set_xlabel("–†–µ–∑—É–ª—å—Ç–∞—Ç")
    ax2.set_ylabel("–î–æ–ª—è")
    ax2.set_title(f"–ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ (shots={shots})")
    st.pyplot(fig2, clear_figure=True)

    # –ü–æ–∫–∞–∂–µ–º —Å—Ö–µ–º—É
    @qml.qnode(qml.device("default.qubit", wires=1))
    def draw_only(t):
        qml.RY(t, wires=0)
        return qml.probs(wires=0)

    st.subheader("üß© –ö–≤–∞–Ω—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞")
    st.code(qml.draw(draw_only)(theta), language="text")

    st.subheader("üë∂ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞–∫ 5-–ª–µ—Ç–Ω–µ–º—É")
    st.write(
        "–ü—Ä–µ–¥—Å—Ç–∞–≤—å –≤–æ–ª—à–µ–±–Ω—É—é –º–æ–Ω–µ—Ç–∫—É ‚öõÔ∏è\n\n"
        "–û–±—ã—á–Ω–∞—è –º–æ–Ω–µ—Ç–∫–∞: —Ç—ã –±—Ä–æ—Å–∞–µ—à—å ‚Äî –≤—ã–ø–∞–¥–∞–µ—Ç **–æ—Ä—ë–ª –∏–ª–∏ —Ä–µ—à–∫–∞**.\n\n"
        "–ö–≤–∞–Ω—Ç–æ–≤–∞—è –º–æ–Ω–µ—Ç–∫–∞: –ø–æ–∫–∞ —Ç—ã –Ω–µ –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∞, –æ–Ω–∞ –∫–∞–∫ –±—É–¥—Ç–æ **–º–æ–∂–µ—Ç –±—ã—Ç—å –∏ 0, –∏ 1**.\n"
        "–ê —Ä—É—á–∫–∞ Œ∏ ‚Äî —ç—Ç–æ –∫–∞–∫ **–ø–æ–∫—Ä—É—Ç–∏—Ç—å –º–æ–Ω–µ—Ç–∫—É –ø–µ—Ä–µ–¥ –±—Ä–æ—Å–∫–æ–º**.\n\n"
        "–ï—Å–ª–∏ Œ∏ –º–∞–ª–µ–Ω—å–∫–∏–π ‚Äî —á–∞—â–µ –≤—ã–ø–∞–¥–∞–µ—Ç 0.\n"
        "–ï—Å–ª–∏ Œ∏ –¥—Ä—É–≥–æ–π ‚Äî —á–∞—â–µ –≤—ã–ø–∞–¥–∞–µ—Ç 1.\n\n"
        "–ê shots ‚Äî —ç—Ç–æ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Ç—ã –±—Ä–æ—Å–∞–µ—à—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É üé≤"
    )

    st.markdown("---")
    st.caption("–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å Quantum ML: –Ω–∞—É—á–∏–º Œ∏ –æ–±—É—á–∞—Ç—å—Å—è (loss –ø–∞–¥–∞–µ—Ç), –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫–∞—è –∫–≤–∞–Ω—Ç–æ–≤–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å üôÇ")
